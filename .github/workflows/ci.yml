##
## NeuronOS — Cross-Platform CI with Benchmarks
##
## Tier 1: Native (x86_64 Linux, ARM64 Linux)
## Tier 2: QEMU emulation (RISC-V 64)
## Tier 3: Compile-only (-Werror)
##
## Tests:
##   - compile-only: Just build (all platforms)
##   - unit-no-model: HAL, hwinfo (all platforms)
##   - benchmark: Speed report with real model (x86_64)
##
name: NeuronOS CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'neuronos/**'
      - 'src/**'
      - 'include/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'neuronos/**'
      - 'src/**'
      - 'include/**'

env:
  BUILD_TYPE: Release
  BITNET_MODEL_REPO: "microsoft/BitNet-b1.58-2B-4T-gguf"
  BITNET_MODEL_FILE: "ggml-model-i2_s.gguf"

jobs:
  # ═══════════════════════════════════════════════════════
  # Tier 1: Native x86_64 Linux (primary + benchmark)
  # ═══════════════════════════════════════════════════════
  linux-x86_64:
    name: Linux x86_64 (clang)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake bc curl jq

      - name: Build parent BitNet
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DBITNET_X86_TL2=OFF
          cmake --build build -j$(nproc)

      - name: Build NeuronOS
        run: |
          cd neuronos
          cmake -B build \
            -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DCMAKE_C_COMPILER=clang
          cmake --build build -j$(nproc)

      - name: Run HAL tests
        run: |
          cd neuronos/build
          export LD_LIBRARY_PATH=../../build/3rdparty/llama.cpp/src:../../build/3rdparty/llama.cpp/ggml/src
          ./test_hal

      - name: Hardware info
        run: |
          cd neuronos/build
          export LD_LIBRARY_PATH=../../build/3rdparty/llama.cpp/src:../../build/3rdparty/llama.cpp/ggml/src
          ./neuronos-cli hwinfo

      - name: Download model for benchmark
        run: |
          mkdir -p models
          if [ ! -f "models/$BITNET_MODEL_FILE" ]; then
            echo "Downloading BitNet 2B4T model..."
            curl -L -o "models/$BITNET_MODEL_FILE" \
              "https://huggingface.co/$BITNET_MODEL_REPO/resolve/main/$BITNET_MODEL_FILE" \
              --progress-bar || echo "Model download failed (non-fatal)"
          fi

      - name: Run engine tests + benchmark
        if: hashFiles('models/ggml-model-i2_s.gguf') != ''
        run: |
          cd neuronos/build
          export LD_LIBRARY_PATH=../../build/3rdparty/llama.cpp/src:../../build/3rdparty/llama.cpp/ggml/src

          echo "═══════════════════════════════════════"
          echo "  NeuronOS Benchmark — x86_64 Linux"
          echo "═══════════════════════════════════════"

          # Full engine test suite
          ./test_engine ../../models/$BITNET_MODEL_FILE 2>&1 | tee /tmp/bench.txt

          # Extract key metrics
          echo ""
          echo "═══════════════════════════════════════"
          echo "  SPEED REPORT"
          echo "═══════════════════════════════════════"
          grep -oP '[0-9]+\.[0-9]+ t/s' /tmp/bench.txt | while read speed; do
            echo "  $speed"
          done
          grep 'Results:' /tmp/bench.txt

      - name: Generate benchmark summary
        if: always()
        run: |
          echo "## NeuronOS CI — x86_64 Benchmark" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | $(uname -m) $(cat /proc/cpuinfo | grep 'model name' | head -1 | cut -d: -f2) |" >> $GITHUB_STEP_SUMMARY
          echo "| RAM | $(free -h | grep Mem | awk '{print $2}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Cores | $(nproc) |" >> $GITHUB_STEP_SUMMARY
          if [ -f /tmp/bench.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Speed Results" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -E 't/s|Results|PASS|FAIL' /tmp/bench.txt >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  # ═══════════════════════════════════════════════════════
  # Tier 1: Native ARM64 Linux
  # ═══════════════════════════════════════════════════════
  linux-arm64:
    name: Linux ARM64 (gcc)
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc g++ cmake bc

      - name: Build parent BitNet
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DBITNET_X86_TL2=OFF
          cmake --build build -j$(nproc)

      - name: Build NeuronOS
        run: |
          cd neuronos
          cmake -B build -DCMAKE_BUILD_TYPE=$BUILD_TYPE
          cmake --build build -j$(nproc)

      - name: Run tests + hwinfo
        run: |
          cd neuronos/build
          export LD_LIBRARY_PATH=../../build/3rdparty/llama.cpp/src:../../build/3rdparty/llama.cpp/ggml/src
          ./test_hal
          ./neuronos-cli hwinfo

      - name: ARM64 summary
        if: always()
        run: |
          echo "## NeuronOS CI — ARM64" >> $GITHUB_STEP_SUMMARY
          echo "Build: OK | HAL tests: PASS" >> $GITHUB_STEP_SUMMARY

  # ═══════════════════════════════════════════════════════
  # Tier 2: RISC-V 64 via QEMU
  # ═══════════════════════════════════════════════════════
  riscv64-qemu:
    name: RISC-V 64 (QEMU)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: uraimo/run-on-arch-action@v3
        with:
          arch: riscv64
          distro: ubuntu24.04
          githubToken: ${{ github.token }}
          dockerRunArgs: |
            --volume "${PWD}:/opt/neuronos"
          install: |
            apt-get update
            apt-get install -y gcc g++ cmake bc
          run: |
            cd /opt/neuronos
            echo "Building on RISC-V 64 (scalar fallback)..."

            # Build parent (scalar-only, no SIMD)
            cmake -B build \
              -DCMAKE_BUILD_TYPE=Release \
              -DBITNET_X86_TL2=OFF
            cmake --build build -j$(nproc)

            # Build NeuronOS
            cd neuronos
            cmake -B build -DCMAKE_BUILD_TYPE=Release
            cmake --build build -j$(nproc)

            # Run HAL test (scalar backend)
            cd build
            export LD_LIBRARY_PATH=../../build/3rdparty/llama.cpp/src:../../build/3rdparty/llama.cpp/ggml/src
            ./test_hal
            ./neuronos-cli hwinfo
            echo "RISC-V build + tests passed!"

  # ═══════════════════════════════════════════════════════
  # Compile with -Werror
  # ═══════════════════════════════════════════════════════
  compile-warnings:
    name: Compile with -Werror
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install clang
        run: sudo apt-get update && sudo apt-get install -y clang cmake

      - name: Build parent BitNet
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DBITNET_X86_TL2=OFF
          cmake --build build -j$(nproc)

      - name: Build NeuronOS with -Werror
        run: |
          cd neuronos
          cmake -B build \
            -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_C_FLAGS="-Werror"
          cmake --build build -j$(nproc)
