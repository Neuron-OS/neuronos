##
## NeuronOS — Continuous Integration
##
## Builds and tests on every push to main/develop and PRs.
## Uses static linking (BUILD_SHARED_LIBS=OFF) — same as release builds.
##
## Matrix:
##   - Linux x86_64 (GCC)   — full tests + optional benchmark
##   - Linux ARM64 (GCC)    — full tests
##   - Compile warnings      — clang -Werror
##
name: CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'neuronos/**'
      - 'src/**'
      - 'include/**'
      - 'CMakeLists.txt'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ═══════════════════════════════════════════
  # Build + Test matrix
  # ═══════════════════════════════════════════
  build-test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x86_64
            os: ubuntu-22.04
            cc: gcc
            cxx: g++
            run_hal: true
            run_benchmark: true
          - name: linux-arm64
            os: ubuntu-24.04-arm
            cc: gcc
            cxx: g++
            run_hal: true
            run_benchmark: false

    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake

      - name: Configure (static build)
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DBITNET_X86_TL2=OFF \
            -DBUILD_SHARED_LIBS=OFF

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Verify static linking
        run: |
          echo "=== Binary dependencies ==="
          ldd build/bin/neuronos-cli
          if ldd build/bin/neuronos-cli | grep -q libllama; then
            echo "ERROR: dynamically linked to libllama!"
            exit 1
          fi
          echo "OK: statically linked"

      - name: Run HAL tests
        if: matrix.run_hal
        run: ./build/bin/test_hal

      - name: Run memory tests
        run: ./build/bin/test_memory

      - name: Run engine tests (no model)
        run: ./build/bin/test_engine

      - name: Hardware info
        run: ./build/bin/neuronos-cli hwinfo

      - name: Download model for benchmark
        if: matrix.run_benchmark
        continue-on-error: true
        run: |
          mkdir -p models
          curl -L -o models/ggml-model-i2_s.gguf \
            "https://huggingface.co/microsoft/BitNet-b1.58-2B-4T-gguf/resolve/main/ggml-model-i2_s.gguf" \
            --progress-bar --max-time 300

      - name: Run engine tests with model
        if: matrix.run_benchmark && hashFiles('models/ggml-model-i2_s.gguf') != ''
        run: |
          echo "═══════════════════════════════════════"
          echo "  NeuronOS Benchmark — ${{ matrix.name }}"
          echo "═══════════════════════════════════════"
          ./build/bin/test_engine models/ggml-model-i2_s.gguf 2>&1 | tee /tmp/bench.txt
          echo ""
          echo "=== Speed Report ==="
          grep -oP '[0-9]+\.[0-9]+ t/s' /tmp/bench.txt || true
          grep 'Results:' /tmp/bench.txt || true

      - name: CI Summary
        if: always()
        run: |
          echo "## NeuronOS CI — ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | $(uname -m) |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | Static (BUILD_SHARED_LIBS=OFF) |" >> $GITHUB_STEP_SUMMARY
          echo "| Binary size | $(du -h build/bin/neuronos-cli | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          if [ -f /tmp/bench.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Benchmark" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -E 't/s|Results|PASS|FAIL' /tmp/bench.txt >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  # ═══════════════════════════════════════════
  # Compile warnings check (-Werror)
  # ═══════════════════════════════════════════
  warnings:
    name: Compile warnings
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install clang
        run: sudo apt-get update && sudo apt-get install -y clang cmake

      - name: Build with -Werror
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DBITNET_X86_TL2=OFF \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_C_FLAGS="-Werror" \
            -DCMAKE_CXX_FLAGS="-Werror"
          cmake --build build -j$(nproc)
